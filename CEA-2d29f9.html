<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiversX Utilities</title>
    <link rel="stylesheet" href="styles/style.css">
    <style>
        /* Add this style to right-align the table columns */
        #nft_details_table td:nth-child(2),
        #costs_table td,
        #egldCostTable td {
            text-align: right;
        }

        /* Ensure tables have some basic styling for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
            text-align: left;
        }

        .styled-button {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .styled-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="header-text">Cantina Genesis EAPES</h1>
    </header>
    <main>
        
        <div class="container">
            <div class="left">
                <div class="search-container">
                    <label for="identifier" id="identifier-label"></label>
                    <input type="text" id="identifier">
                    <button id="searchButton">Search</button>
                    <div id="egld_button_container"></div> <!-- Container for egldCostButton -->
                </div>
                <div class="frame">
                    <img id="nft_image" src="" alt="NFT Image">
                </div>
                <div id="egld_cost_container"></div>
            </div>
            <div class="right">
                <label for="nft_number">NFT #:</label>
                <input type="text" id="nft_number" readonly style="text-align: right;">
                <table id="nft_details_table">
                    <tr>
                        <th>Attribute</th>
                        <th>Value</th>
                    </tr>
                </table>
                <table id="costs_table">
                    <tr>
                        <th colspan="5">Total accumulated to current level</th>
                    </tr>
                    <tr>
                        <th>XP</th>
                        <th>Shards</th>
                        <th>CRT</th>
                        <th>Equivalent CRT</th>
                        <th>Remaining -> Level 20</th>
                    </tr>
                </table>
                <table id="talents_table">
                    <tr>
                        <th>Talent</th>
                        <th>Value</th>
                    </tr>
                </table>
                
            </div>
        </div>
    </main>
    <script src="scripts/costsPerLevel.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Extract the current HTML file name without the extension
            const path = window.location.pathname;
            const page = path.split("/").pop();
            const pageName = page.replace(".html", "");
        
            // Set the label text dynamically
            const identifierLabel = document.getElementById("identifier-label");
            identifierLabel.textContent = pageName + "-";

            const headerText = localStorage.getItem("headerText");
            if (headerText) {
                document.getElementById("header-text").textContent = headerText;
            }

            const searchButton = document.getElementById("searchButton");
            const egldButtonContainer = document.getElementById("egld_button_container");
            const egldCostContainer = document.getElementById("egld_cost_container");

            searchButton.addEventListener("click", function() {
                const identifier = pageName + '-' + document.getElementById("identifier").value;

                if (!document.getElementById("identifier").value) {
                    alert("Please enter an identifier.");
                    return;
                }

                const mainTable = document.getElementById("nft_details_table");
                mainTable.innerHTML = "<tr><th>Attribute</th><th>Value</th></tr>";

                const talentsTable = document.getElementById("talents_table");
                talentsTable.innerHTML = "<tr><th>Talent</th><th>Value</th></tr>";

                const costsTable = document.getElementById("costs_table");
                costsTable.innerHTML = `
                    <tr>
                        <th colspan="5">Total accumulated to current level</th>
                    </tr>
                    <tr>
                        <th>XP</th>
                        <th>Shards</th>
                        <th>CRT</th>
                        <th>Equivalent CRT</th>
                        <th>Remaining -> Level 20</th>
                    </tr>`;
                // Clear egldCostContainer on new search
                egldCostContainer.innerHTML = '';

                fetch(`https://api.elrond.com/collections/${pageName}/nfts?identifiers=${identifier}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            alert("No data found for the given identifier.");
                            return;
                        }

                        const nftData = data[0];
                        const thumbnailUrl = nftData.media[0].thumbnailUrl;

                        const nftImage = document.getElementById("nft_image");
                        nftImage.src = thumbnailUrl;

                        const nftNumberInput = document.getElementById("nft_number");
                        nftNumberInput.value = nftData.metadata.id;

                        const dynamicDataURL = nftData.metadata.stats;

                        fetch(dynamicDataURL)
                            .then(response => response.json())
                            .then(dynamicData => {
                                let currentLevel = dynamicData.level || 0;
                                let characterTokens = dynamicData.character_tokens || 0;
                                const children = dynamicData.gameData[0].dynamicData;
                                for (const key in children) {
                                    const value = children[key];
                                    if (key === "talents") {
                                        value.forEach(talent => {
                                            if (talent.value !== 0) {
                                                const talentRow = talentsTable.insertRow(-1);
                                                talentRow.insertCell(0).textContent = talent.name;
                                                talentRow.insertCell(1).textContent = talent.value;
                                            }
                                        });
                                    } else {
                                        const row = mainTable.insertRow(-1);
                                        row.insertCell(0).textContent = key;
                                        row.insertCell(1).textContent = value;

                                        if (key === "level") {
                                            currentLevel = value;
                                        } else if (key === "character_tokens") {
                                            characterTokens = value;
                                        }
                                    }
                                }
                                console.log(`Current Level: ${currentLevel}`);
                                const levelCosts = costsPerLevel[currentLevel - 1];
                                if (levelCosts) {
                                    const maxCostCRT = costsPerLevel[19].crt + (costsPerLevel[19].xp * 14000 / 3500) + (costsPerLevel[19].shards * (22500 * 9800 / 45000) / 500000);
                                    
                                    let totalCRTCost = levelCosts.crt + (levelCosts.xp * 14000 / 3500) + (levelCosts.shards * (22500 * 9800 / 45000) / 500000);

                                    if (totalCRTCost > maxCostCRT) {
                                        totalCRTCost = maxCostCRT;
                                    }

                                    const level20Cost = maxCostCRT - totalCRTCost;

                                    const row = costsTable.insertRow(-1);
                                    row.insertCell(0).textContent = levelCosts.xp;
                                    row.insertCell(1).textContent = levelCosts.shards;
                                    row.insertCell(2).textContent = levelCosts.crt;
                                    row.insertCell(3).textContent = totalCRTCost.toFixed(2);
                                    row.insertCell(4).textContent = level20Cost.toFixed(2);
                                    // Remove previous egldCostButton if exists
                                    egldButtonContainer.innerHTML = '';

                                    const egldCostButton = document.createElement("button");
                                    egldCostButton.id = "egldCostButton";
                                    egldCostButton.textContent = "Calculate EGLD Costs";
                                    egldCostButton.classList.add("styled-button");
                                    egldCostButton.addEventListener("click", function() {
                                        fetch("https://api.elrond.com/accounts/erd1qqqqqqqqqqqqqpgqf57y8m9krsvrceqxujngzm77p82zqc502jpsnnezqs/tokens?identifiers=CRT-52decf,WEGLD-bd4d79")
                                            .then(response => response.json())
                                            .then(tokenData => {
                                                let crtBalance, wegldBalance;

                                                for (const token of tokenData) {
                                                    if (token.identifier === "CRT-52decf") {
                                                        crtBalance = BigInt(token.balance);
                                                    } else if (token.identifier === "WEGLD-bd4d79") {
                                                        wegldBalance = BigInt(token.balance);
                                                    }
                                                }

                                                const currentEgldCost = totalCRTCost * (Number(wegldBalance) / Number(crtBalance));
                                                const level20EgldCost = level20Cost * (Number(wegldBalance) / Number(crtBalance));

                                                let egldCostTable = document.getElementById("egldCostTable");
                                                if (!egldCostTable) {
                                                    egldCostTable = document.createElement("table");
                                                    egldCostTable.id = "egldCostTable";
                                                    egldCostTable.innerHTML = `
                                                        <tr>
                                                            <th>Current EGLD Cost</th>
                                                            <th>Level 20 EGLD Cost</th>
                                                        </tr>
                                                    `;
                                                    egldCostContainer.appendChild(egldCostTable);
                                                }

                                                // Clear the table body before adding new rows
                                                egldCostTable.innerHTML = `
                                                    <tr>
                                                        <th>Current EGLD Cost</th>
                                                        <th>Level 20 EGLD Cost</th>
                                                    </tr>
                                                    <tr>
                                                        <td>${currentEgldCost.toFixed(2)}</td>
                                                        <td>${level20EgldCost.toFixed(2)}</td>
                                                    </tr>
                                                `;
                                            })
                                            .catch(error => console.error("Error fetching token data:", error));
                                    });
                                    egldButtonContainer.appendChild(egldCostButton);
                                }
                            })
                            .catch(error => console.error("Error fetching dynamic data:", error));
                    })
                    .catch(error => console.error("Error fetching NFT data:", error));
            });

        });
    </script>
    <div id="footer-placeholder"></div>
    <script src="scripts/footer.js"></script>
</body>
</html>
